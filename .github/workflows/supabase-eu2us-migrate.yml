name: Supabase EU -> US migrate

on:
  workflow_dispatch:
    inputs:
      confirm_overwrite:
        description: "Type MIGRATE to confirm this will overwrite the destination database"
        required: true
      schemas:
        description: "Comma-separated schemas to migrate (default: public). Avoid auth/storage unless you know you need them."
        required: false
        default: "public"

concurrency:
  group: supabase-eu2us-migrate
  cancel-in-progress: false

jobs:
  migrate:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    steps:
      - name: Validate confirmation
        shell: bash
        run: |
          if [ "${{ inputs.confirm_overwrite }}" != "MIGRATE" ]; then
            echo "Refusing to run: confirm_overwrite must be MIGRATE"
            exit 1
          fi

      - name: Checkout
        uses: actions/checkout@v4

      - name: Install Postgres client
        shell: bash
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump source (EU)
        shell: bash
        env:
          EU_DB_HOST: ${{ secrets.EU_DB_HOST }}
          EU_DB_PASSWORD: ${{ secrets.EU_DB_PASSWORD }}
          EU_DB_PORT: ${{ secrets.EU_DB_PORT }}
          EU_DB_USER: ${{ secrets.EU_DB_USER }}
          EU_DB_NAME: ${{ secrets.EU_DB_NAME }}
          SCHEMAS: ${{ inputs.schemas }}
        run: |
          set -euo pipefail

          if [ -z "${EU_DB_HOST:-}" ] || [ -z "${EU_DB_PASSWORD:-}" ]; then
            echo "Missing required secrets: EU_DB_HOST and/or EU_DB_PASSWORD"
            exit 1
          fi

          EU_DB_PORT="${EU_DB_PORT:-5432}"
          EU_DB_USER="${EU_DB_USER:-postgres}"
          EU_DB_NAME="${EU_DB_NAME:-postgres}"

          schema_args=()
          IFS=',' read -ra schemas <<< "${SCHEMAS:-}"
          for s in "${schemas[@]}"; do
            s="$(echo "$s" | xargs)"
            [ -n "$s" ] && schema_args+=("-n" "$s")
          done
          if [ "${#schema_args[@]}" -eq 0 ]; then
            echo "No schemas provided; refusing to run."
            exit 1
          fi

          export PGPASSWORD="$EU_DB_PASSWORD"
          export PGSSLMODE="require"
          export PGCONNECT_TIMEOUT="15"

          # GitHub-hosted runners can be IPv4-only; force IPv4 if possible.
          EU_DB_HOSTADDR="$(getent ahostsv4 "$EU_DB_HOST" 2>/dev/null | awk 'NR==1{print $1}' || true)"
          if [ -z "$EU_DB_HOSTADDR" ]; then
            echo "Could not resolve IPv4 for EU_DB_HOST; using hostname only."
            getent ahosts "$EU_DB_HOST" || true
            pg_dump -Fc --no-owner --no-privileges \
              -h "$EU_DB_HOST" -p "$EU_DB_PORT" -U "$EU_DB_USER" -d "$EU_DB_NAME" \
              "${schema_args[@]}" \
              -f supabase.dump
          else
            pg_dump -Fc --no-owner --no-privileges \
              --dbname="host=$EU_DB_HOST hostaddr=$EU_DB_HOSTADDR port=$EU_DB_PORT user=$EU_DB_USER dbname=$EU_DB_NAME sslmode=require" \
              "${schema_args[@]}" \
              -f supabase.dump
          fi

      - name: Restore to destination (US)
        shell: bash
        env:
          US_DB_HOST: ${{ secrets.US_DB_HOST }}
          US_DB_PASSWORD: ${{ secrets.US_DB_PASSWORD }}
          US_DB_PORT: ${{ secrets.US_DB_PORT }}
          US_DB_USER: ${{ secrets.US_DB_USER }}
          US_DB_NAME: ${{ secrets.US_DB_NAME }}
        run: |
          set -euo pipefail

          if [ -z "${US_DB_HOST:-}" ] || [ -z "${US_DB_PASSWORD:-}" ]; then
            echo "Missing required secrets: US_DB_HOST and/or US_DB_PASSWORD"
            exit 1
          fi

          US_DB_PORT="${US_DB_PORT:-5432}"
          US_DB_USER="${US_DB_USER:-postgres}"
          US_DB_NAME="${US_DB_NAME:-postgres}"

          export PGPASSWORD="$US_DB_PASSWORD"
          export PGSSLMODE="require"
          export PGCONNECT_TIMEOUT="15"

          # GitHub-hosted runners can be IPv4-only; force IPv4 if possible.
          US_DB_HOSTADDR="$(getent ahostsv4 "$US_DB_HOST" 2>/dev/null | awk 'NR==1{print $1}' || true)"
          if [ -z "$US_DB_HOSTADDR" ]; then
            echo "Could not resolve IPv4 for US_DB_HOST; using hostname only."
            getent ahosts "$US_DB_HOST" || true
            pg_restore --clean --if-exists --no-owner --no-privileges \
              -h "$US_DB_HOST" -p "$US_DB_PORT" -U "$US_DB_USER" -d "$US_DB_NAME" \
              supabase.dump
          else
            pg_restore --clean --if-exists --no-owner --no-privileges \
              --dbname="host=$US_DB_HOST hostaddr=$US_DB_HOSTADDR port=$US_DB_PORT user=$US_DB_USER dbname=$US_DB_NAME sslmode=require" \
              supabase.dump
          fi

      - name: Upload dump artifact (for rollback)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: supabase-dump
          path: supabase.dump
          retention-days: 7
