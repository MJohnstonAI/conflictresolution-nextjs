name: Supabase EU -> US migrate

on:
  workflow_dispatch:

jobs:
  dump-and-restore:
    runs-on: ubuntu-latest
    steps:
      - name: Install Postgres client
        run: |
          sudo apt-get update
          sudo apt-get install -y postgresql-client

      - name: Dump EU database (custom format)
        env:
          EU_DB_HOST: ${{ secrets.EU_DB_HOST }}
          EU_DB_PASSWORD: ${{ secrets.EU_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          export PGPASSWORD="$EU_DB_PASSWORD"
          pg_dump -Fc -h "$EU_DB_HOST" -U postgres -d postgres -f supabase-eu.dump

      - name: Restore into US database
        env:
          US_DB_HOST: ${{ secrets.US_DB_HOST }}
          US_DB_PASSWORD: ${{ secrets.US_DB_PASSWORD }}
          PGSSLMODE: require
        run: |
          export PGPASSWORD="$US_DB_PASSWORD"
          pg_restore --clean --if-exists -h "$US_DB_HOST" -U postgres -d postgres supabase-eu.dump
